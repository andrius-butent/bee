<?xml version="1.0" encoding="UTF-8"?>
<Table xmlns="http://www.butent.com/table"

  name="TradeActItems"
  idName="TradeActItemID"
  >
  <Fields>
    <Relation name="TradeAct" notNull="true" relation="TradeActs" cascade="DELETE" 
      label="=tradeAct" />

    <Relation name="Parent" relation="TradeActs" label="=taParent" />

    <Relation name="Item" notNull="true" relation="Items" label="=item" />

    <Numeric name="Quantity" precision="12" scale="3" notNull="true" label="=quantity" />
    <Numeric name="Price" precision="12" scale="2" label="=price" />
    <Numeric name="RentalPrice" precision="12" scale="2" label="=rentalSum" />

    <Boolean name="VatPlus" label="=vatPlus" defValue="true" />
    <Numeric name="Vat" precision="12" scale="2" label="=vat" />
    <Boolean name="VatPercent" label="=vatPercent" />

    <Numeric name="Discount" precision="7" scale="3" label="=discountPercent" />

    <Text name="Note" label="=note" />
    <Relation name="Sale" relation="Sales" cascade="SET_NULL" label="=trdInvoiceId" />
  </Fields>
  <Triggers>
    <Trigger timing="AFTER" events="INSERT UPDATE DELETE" scope="ROW">
      <PostgreSql><![CDATA[
DECLARE _id BIGINT;
DECLARE _rId BIGINT;
BEGIN
  IF(TG_OP='DELETE') THEN
    _id:=COALESCE(OLD."Parent", OLD."TradeAct");
   ELSE
    _id:=COALESCE(NEW."Parent", NEW."TradeAct");
   END IF;

   UPDATE "TradeActs" SET "RemainItemQuantity" = (
      SELECT
        SUM(COALESCE("Quantity", 0)) - COALESCE((
              SELECT
                SUM("ti"."Quantity")
              FROM "TradeActs" AS "ta"
              INNER JOIN "TradeActItems" AS "ti" ON "ta"."TradeActID" = "ti"."TradeAct"
              WHERE "ti"."Parent" = _id AND "ta"."Kind" = 2
             ), 0)
      FROM "TradeActItems" WHERE "TradeAct" = _id
    )
   WHERE "TradeActID"=_id AND "Kind" IN (0, 1, 7);

   _rId:=(SELECT
      "ta1"."RentProject"
     FROM "TradeActs" AS "ta1"
     WHERE "ta1"."TradeActID" = _id AND "ta1"."RentProject" IS NOT NULL
     LIMIT 1);

   IF(_rId IS NULL) THEN
      RETURN NULL;
   END IF;

   UPDATE "TradeActs" SET "RemainItemQuantity" = (
      SELECT
        SUM(COALESCE("ta2"."RemainItemQuantity", 0))
      FROM "TradeActs" as "ta2"
      WHERE ("ta2"."RentProject" =_rId) AND "ta2"."Kind" IN (0, 1, 7)
    )
   WHERE "TradeActID" = _rId AND "Kind" = 8;

   RETURN NULL;
END;
      ]]></PostgreSql>
      <MsSql></MsSql>
      <Oracle></Oracle>
    </Trigger>
  </Triggers>
</Table>
