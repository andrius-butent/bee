<?xml version="1.0" encoding="UTF-8"?>
<Table xmlns="http://www.butent.com/table"

  name="Sales"
  idName="SaleID"
  >
  <Fields>
    <DateTime name="Date" notNull="true" defExpr="CURRENT_TIME" label="=trdDate" />
    <String name="Number" precision="50" label="=trdNumber" />
    <String name="InvoicePrefix" precision="10" label="=trdInvoicePrefix" />
    <String name="InvoiceNo" precision="20" label="=trdInvoiceNo" />

    <Relation name="Supplier" relation="Companies" label="=trdSupplier" />
    <Relation name="Customer" relation="Companies" label="=trdCustomer" />
    <Relation name="Payer" relation="Companies" label="=trdPayer" />

    <Relation name="WarehouseFrom" relation="Warehouses" label="=trdWarehouseFrom" />

    <Numeric name="Amount" precision="12" scale="2" label="=trdTotal" />
    <Relation name="Currency" relation="Currencies" notNull="true" />
    <Boolean name="VatIncluded" label="=trdVatIncluded" />

    <Date name="Term" label="=trdTerm" />
    <DateTime name="PaymentTime" label="=trdPaymentTime" />
    <Numeric name="Paid" precision="12" scale="2" label="=trdPaid" />

    <Relation name="Manager" relation="Users" label="=trdManager" />

    <String name="Vehicle" precision="100" label="=trdVehicle" />
    <String name="Driver" precision="100" label="=trdDriver" />
    <Text name="Notes" label="=trdNotes" />

    <Boolean name="Proforma" label="=trdProformaInvoice" />
    <DateTime name="Exported" label="=trdExported" />
  </Fields>

  <Indexes>
    <Index fields="Proforma" />
  </Indexes>

  <Triggers>
    <Trigger events="UPDATE" scope="ROW" timing="AFTER">
      <PostgreSql>
        <![CDATA[
DECLARE _id BIGINT;
BEGIN
  IF ((OLD."VatIncluded" IS NULL)!=(NEW."VatIncluded" IS NULL) OR
      OLD."VatIncluded"!=NEW."VatIncluded") THEN
    _id:=OLD."SaleID";
    
    UPDATE "Sales" SET "Amount"=(SELECT SUM("Quantity"*"Price"+
        CASE WHEN "VatIncluded"=1 OR "Vat" IS NULL THEN 0
             WHEN "VatPercent"=1 THEN "Quantity"*"Price"/100*"Vat"
             ELSE "Vat" END)
      FROM "SaleItems" INNER JOIN "Sales" ON "SaleItems"."Sale"="Sales"."SaleID"
      WHERE "Sale"=_id) WHERE "SaleID"=_id;
  END IF;
  RETURN NULL;
END;
        ]]>
      </PostgreSql>
      <MsSql />
      <Oracle />
    </Trigger>
  </Triggers>
</Table>