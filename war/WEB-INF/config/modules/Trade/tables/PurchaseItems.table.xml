<?xml version="1.0" encoding="UTF-8"?>
<Table xmlns="http://www.butent.com/table"

  name="PurchaseItems"
  idName="PurchaseItemID"
  >
  <Fields>
    <Relation name="Purchase" notNull="true" relation="Purchases" cascade="DELETE" />
    <Relation name="Item" notNull="true" relation="Items" label="=item" />
    <String name="Article" precision="30" label="=article" />
    <Numeric name="Quantity" precision="12" scale="3" notNull="true" label="=trdQuantity" />
    <Numeric name="Price" precision="12" scale="2" label="=trdPrice" />
    <Numeric name="Vat" precision="12" scale="2" label="=trdVat" />
    <Boolean name="VatPercent" label="=trdVatPercent" />
    <Text name="Note" label="=trdNote" />
    <Relation name="Parent" relation="PurchaseItems" />
  </Fields>
  <Triggers>
    <Trigger events="INSERT UPDATE DELETE" scope="ROW" timing="AFTER">
      <PostgreSql>
        <![CDATA[
DECLARE _id BIGINT;
BEGIN
  IF (TG_OP='INSERT') THEN
    _id:=NEW."Purchase";
  ELSE
    _id:=OLD."Purchase";
  END IF;

  UPDATE "Purchases" SET "Amount"=(SELECT SUM("Quantity"*"Price"+
      CASE WHEN "VatIncluded"=1 OR "Vat" IS NULL THEN 0
           WHEN "VatPercent"=1 THEN "Quantity"*"Price"/100*"Vat"
           ELSE "Vat" END)
    FROM "PurchaseItems" INNER JOIN "Purchases"
      ON "PurchaseItems"."Purchase"="Purchases"."PurchaseID"
    WHERE "Purchase"=_id) WHERE "PurchaseID"=_id;
  RETURN NULL;
END;
        ]]>
      </PostgreSql>
      <MsSql />
      <Oracle />
    </Trigger>
  </Triggers>
</Table>
